{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/kamishibai/scenario-v0.schema.json",
  "title": "Scenario v0",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "id",
    "nodes"
  ],
  "properties": {
    "id": {
      "type": "string",
      "minLength": 1
    },
    "nodes": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/command"
      }
    }
  },
  "$defs": {
    "command": {
      "oneOf": [
        {
          "$ref": "#/$defs/labelCommand"
        },
        {
          "$ref": "#/$defs/sayCommand"
        },
        {
          "$ref": "#/$defs/choiceCommand"
        },
        {
          "$ref": "#/$defs/jumpCommand"
        },
        {
          "$ref": "#/$defs/setCommand"
        },
        {
          "$ref": "#/$defs/ifCommand"
        }
      ]
    },
    "labelCommand": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "name"
      ],
      "properties": {
        "type": {
          "const": "label"
        },
        "name": {
          "type": "string",
          "pattern": "^[A-Za-z_][A-Za-z0-9_-]*$"
        }
      }
    },
    "sayCommand": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "text"
      ],
      "properties": {
        "type": {
          "const": "say"
        },
        "speaker": {
          "type": "string",
          "minLength": 1
        },
        "text": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "choiceOption": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "text",
        "jump"
      ],
      "properties": {
        "text": {
          "type": "string",
          "minLength": 1
        },
        "jump": {
          "type": "string",
          "pattern": "^[A-Za-z_][A-Za-z0-9_-]*$"
        }
      }
    },
    "choiceCommand": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "options"
      ],
      "properties": {
        "type": {
          "const": "choice"
        },
        "prompt": {
          "type": "string",
          "minLength": 1
        },
        "options": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/choiceOption"
          }
        }
      }
    },
    "jumpCommand": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "to"
      ],
      "properties": {
        "type": {
          "const": "jump"
        },
        "to": {
          "type": "string",
          "pattern": "^[A-Za-z_][A-Za-z0-9_-]*$"
        }
      }
    },
    "setOp": {
      "type": "string",
      "enum": [
        "assign",
        "add",
        "sub"
      ]
    },
    "setValue": {
      "oneOf": [
        {
          "type": "string"
        },
        {
          "type": "number"
        },
        {
          "type": "boolean"
        },
        {
          "type": "null"
        }
      ]
    },
    "setCommand": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "var",
        "value"
      ],
      "properties": {
        "type": {
          "const": "set"
        },
        "var": {
          "type": "string",
          "pattern": "^[A-Za-z_][A-Za-z0-9_.-]*$"
        },
        "op": {
          "$ref": "#/$defs/setOp"
        },
        "value": {
          "$ref": "#/$defs/setValue"
        }
      }
    },
    "condition": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "var",
        "op",
        "value"
      ],
      "properties": {
        "var": {
          "type": "string",
          "pattern": "^[A-Za-z_][A-Za-z0-9_.-]*$"
        },
        "op": {
          "type": "string",
          "enum": [
            "eq",
            "ne",
            "gt",
            "gte",
            "lt",
            "lte"
          ]
        },
        "value": {
          "$ref": "#/$defs/setValue"
        }
      }
    },
    "ifCommand": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "cond",
        "then"
      ],
      "properties": {
        "type": {
          "const": "if"
        },
        "cond": {
          "$ref": "#/$defs/condition"
        },
        "then": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/command"
          }
        },
        "else": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/command"
          }
        }
      }
    }
  }
}
