# シンプルなビジュアルノベルエンジン（Python API + SPA）

本ドキュメントは、現プロダクトを **シンプルなビジュアルノベルエンジン**として実装・拡張するためのアーキテクチャ基準を定義する。
特に、Python 側の実行機（インタプリタ）と React 側の描画レイヤーを明確に分離し、再現性の高い開発・運用を行うことを目的とする。

## 技術スタック

- **Backend**: Python, FastAPI, Uvicorn
- **Frontend**: React + TypeScript + Vite
- **テスト**: pytest（API / E2E）

## 1. スコープと設計方針

- サーバは Python API として、プロジェクト管理・シナリオ供給・アセット配信・セーブ保存を担う。
- クライアントは SPA（React）として、サーバ API とセーブデータを利用して画面描画と入力受付を担う。
- シナリオ解釈（分岐・進行管理）は実行機の責務、UI 表示は描画レイヤーの責務とし、相互に責務を越境させない。

## 2. モノレポ正式構成

本リポジトリは以下を正式なルート構成とする。

- `server/`: Python API と実行機（インタプリタ）
- `web/`: React SPA（描画レイヤー）
- `shared/`: 共有スキーマ・型・規約ドキュメント（言語横断）
- `docs/`: 設計・運用・開発手順

## 3. 責務分離（実行機 vs 描画レイヤー）

### 3.1 実行機（Interpreter / Engine, `server/`）

- シナリオ形式 v0 を読み込み、現在ノード・状態遷移・choice 分岐を評価する。
- セーブデータの読み書きを行い、復元可能な進行状態を保証する。
- アセット参照規約に沿って、必要なアセットを解決し配信可能な形にする。
- API 契約（v0）に従い、プロジェクト/シナリオ/セーブ関連の入出力を提供する。

### 3.2 描画レイヤー（Renderer / UI, `web/`）

- API から取得したシナリオ状態を画面に描画する。
- テキスト、立ち絵、背景、選択肢などの表示とユーザー入力を処理する。
- UI 状態（ローディング、エラー、遷移中表示）を管理する。
- シナリオ進行ロジックを独自実装せず、実行機の結果を表示することに徹する。

## 4. データ規約の参照先

以下の規約は `shared/` 配下に定義し、本ドキュメントから参照する。

- シナリオ形式 v0: `shared/specs/scenario-format-v0.md`
- セーブデータ仕様: `shared/specs/save-data-v0.md`
- アセット参照規約: `shared/specs/asset-reference.md`

## 5. API v0 一覧

API v0 では以下を提供対象とする。

- プロジェクト一覧取得
  - `GET /api/v0/projects`
- プロジェクト単体取得
  - `GET /api/v0/projects/{project_id}`
- シナリオ取得
  - `GET /api/v0/projects/{project_id}/scenario`
- アセット配信
  - `GET /api/v0/assets/{asset_path}`
- セーブ保存
  - `PUT /api/v0/projects/{project_id}/saves/{slot}`

## 6. 開発コマンド（ワンコマンド起動前提）

現時点のリポジトリには、アプリ起動・ビルド・テストを実行するための専用コマンド（例: `make dev`, `npm run dev`, `uvicorn ...` など）は未定義である。
そのため、本節では存在確認済みのコマンドのみを記載する。

- リポジトリ状態確認
  - `git status`

> 実装追加時は、`server/` と `web/` を同時起動できるワンコマンド（例: `make dev`）を導入し、本節を更新すること。

## 7. 受け入れ基準

以下を満たした変更を受け入れ可能とする。

- **再現性**: 同一入力シナリオと同一セーブデータから、同一の進行結果を再現できる。
- **型整合**: `shared/` の契約（型・スキーマ）と `server/` / `web/` の入出力が矛盾しない。
- **choice 分岐**: 選択肢による分岐が仕様どおり遷移し、セーブ/ロード後も整合する。
- **CI バリデーション**: 主要チェック（型検査・テスト・必要なビルド）が CI で自動検証される。
