# アセット参照規約 v0

## 目的
本ドキュメントは、シンプルなビジュアルノベルエンジンで利用するアセット（画像・音声）の参照方法を統一し、実装間の差異と実行時エラーを減らすための基準を定義する。

## 1. パス規約（固定）
アセットはプロジェクトルート直下の `assets/` 配下に配置し、種別ごとに以下を固定ディレクトリとする。

- 背景画像: `assets/bg/...`
- 立ち絵画像: `assets/ch/...`
- 効果音: `assets/se/...`
- BGM: `assets/bgm/...`

### 1.1 参照IDと実ファイルの対応
- シナリオやAPIで扱う `id` は、上記固定ディレクトリ配下の相対パス（拡張子なし）を基本とする。
  - 例: `bg` の `id: school/classroom_day` は `assets/bg/school/classroom_day.avif` を指す。
  - 例: `se` の `id: ui/click` は `assets/se/ui/click.opus` を指す。
- 実装側は対応拡張子（画像: `.avif` 優先、音声: `.opus` 優先）を順次解決してよい。

## 2. 命名規則と解像度ガイドライン

## 2.1 命名規則（推奨）
命名は **英小文字 + スネークケース（`snake_case`）** を推奨し、v0の標準とする。

- 使用可能文字: `a-z`, `0-9`, `_`, `/`
- 禁止: 大文字、スペース、全角文字、記号（`-` など）
- 理由: OS差分やURLエンコード問題を避け、シナリオ記述とファイル名の対応を単純化するため。

例:
- `assets/bg/school/classroom_day.avif`
- `assets/ch/hero/hero_happy.avif`
- `assets/se/ui/cursor_move.opus`
- `assets/bgm/scene/morning_theme.opus`

> 既存資産がケバブケース（`kebab-case`）の場合、移行期間は許容するが、新規追加は `snake_case` に統一する。

## 2.2 解像度ガイドライン（推奨）

### 背景（`assets/bg`）
- 基準解像度: **1920x1080**（16:9）
- 最低解像度: 1280x720
- 形式: AVIF（可逆/高圧縮）

### 立ち絵（`assets/ch`）
- 基準高さ: **1600px 前後**（幅はキャラに応じて可変）
- 透過対応形式必須（AVIF もしくは PNG）
- 同キャラの表情差分は同一キャンバスサイズを推奨（表示揺れ防止）

### 音声（`assets/se`, `assets/bgm`）
- 推奨形式: Opus
- 推奨サンプルレート: 44.1kHz または 48kHz
- SE は短尺・低遅延重視、BGM はループ境界が自然につながる素材を推奨

## 3. ロード戦略（プリロード/遅延ロード）

## 3.1 プリロード対象（固定）
初期体験と演出破綻防止のため、以下をプリロード対象とする。

- 背景（`assets/bg`）: 次シーンで使用予定の背景
- 立ち絵（`assets/ch`）: 現在シーンと直後に表示される主要キャラ差分
- 音（`assets/se`, `assets/bgm`）:
  - 初回画面で即時再生されるSE
  - 最初のシーンで使用するBGM

## 3.2 遅延ロード対象
以下は遅延ロード（必要時取得）を基本とする。

- 分岐先でのみ利用される背景・立ち絵
- 低頻度SE
- 2曲目以降のBGM
- 未到達チャプターのアセット

## 4. Missing Asset時の挙動（固定）

## 4.1 開発モード
missing asset を検知した場合、以下を必須とする。

1. 画面上に代替表示を出す（例: 「Missing BG: school/roof_night」）。
2. コンソールに警告を出す（カテゴリ: `ASSET_MISSING`、解決対象パス付き）。
3. API/validator が警告を返す（HTTPレスポンスまたは検証結果に warning を格納）。

> 開発モードでは「問題を見える化」することを優先し、クラッシュは避ける。

## 4.2 本番モード
missing asset を検知しても、以下を必須とする。

- フォールバック表示（背景: 無地プレースホルダ、立ち絵: 非表示または代替シルエット、音: 無音）
- 非クラッシュ継続（シナリオ進行は停止しない）
- 必要に応じて低頻度ログ送信（監視用）

## 5. 検証方法（missing assetサンプル計画）
実装検証のため、意図的に存在しないアセット参照を含むサンプルを追加する計画を本仕様に含める。

- 予定ファイル例: `shared/scenarios/asset_missing_sample.yaml`
- サンプル要件:
  - 存在しない背景 `bg: id=debug/not_found_bg`
  - 存在しない立ち絵 `ch: id=debug/not_found_ch`
  - 存在しないSE `se: id=debug/not_found_se`
  - 存在しないBGM `bgm: action=start, id=debug/not_found_bgm`
- 検証観点:
  - 開発モードで代替表示・コンソール警告・validator警告が発生する。
  - 本番モードでフォールバックされ、クラッシュせず進行できる。

## 6. 今後の拡張
- 音量正規化ルール（LUFS）
- WebP/AVIF など次世代画像形式への対応
- 章単位のアセットマニフェストと先読み最適化
